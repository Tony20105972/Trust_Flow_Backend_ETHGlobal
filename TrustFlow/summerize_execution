!pip install groq


# summarize_execution.py
import os
import getpass
from typing import List, Optional
from groq import Groq

# ----------------------------------------------------------------------
# 1. Groq API Key Setup (ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ ì‹œ API í‚¤ ì²˜ë¦¬)
# ----------------------------------------------------------------------
_groq_api_key_global: Optional[str] = os.getenv("GROQ_API_KEY")

if not _groq_api_key_global:
    print("âš ï¸ GROQ_API_KEY í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    user_choice = input("Groq API í‚¤ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì—¬ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ").strip().lower()
    if user_choice == 'y':
        _groq_api_key_global = getpass.getpass("ğŸ” Groq API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì…ë ¥ê°’ì€ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤): ").strip()
        if not _groq_api_key_global:
            print("API í‚¤ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
            exit(1)
    else:
        print("API í‚¤ ì—†ì´ëŠ” ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
        exit(1)

try:
    _groq_client_global = Groq(api_key=_groq_api_key_global)
    print("âœ… Groq í´ë¼ì´ì–¸íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")
except Exception as e:
    print(f"âŒ Groq í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
    print("ì œê³µëœ API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ì—°ê²° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
    exit(1)


# ----------------------------------------------------------------------
# 2. ExecutionSummarizer Class (ì „ì—­ Groq í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš©)
# ----------------------------------------------------------------------
class ExecutionSummarizer:
    """
    ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸ ë°°í¬ ë° ì‹¤í–‰ ë¡œê·¸ë¥¼ ìì—°ì–´ ìš”ì•½ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í´ë˜ìŠ¤ì…ë‹ˆë‹¤.
    Groq APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹ ë¥´ê³  íš¨ìœ¨ì ì¸ AI ìš”ì•½ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
    """
    def __init__(self, model_name: str = "llama3-8b-8192"):
        print(f"ğŸ› ï¸ ExecutionSummarizer ì´ˆê¸°í™” ì¤‘. Groq ëª¨ë¸: '{model_name}' ì„¤ì • ì¤‘...")
        self.client = _groq_client_global
        self.model_name = model_name
        print("âœ… ExecutionSummarizer ì´ˆê¸°í™” ì™„ë£Œ. Groq í´ë¼ì´ì–¸íŠ¸ ì¤€ë¹„ë¨.")

    def summarize(self, logs: List[str], max_tokens: int = 220, language: str = "ko") -> str: # max_tokens, language ì¶”ê°€
        """
        ì œê³µëœ ë¡œê·¸ ë¦¬ìŠ¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ Groq APIë¥¼ ì‚¬ìš©í•˜ì—¬ ìš”ì•½ í…ìŠ¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

        Args:
            logs (List[str]): ìš”ì•½í•  ë¡œê·¸ ë©”ì‹œì§€ë“¤ì˜ ë¦¬ìŠ¤íŠ¸.
            max_tokens (int): ìƒì„±ë  ìš”ì•½ë¬¸ì˜ ìµœëŒ€ í† í° ìˆ˜. (ê¸°ë³¸ê°’: 220)
            language (str): ìš”ì•½ë¬¸ì˜ ì–¸ì–´ ('ko' for Korean, 'en' for English). (ê¸°ë³¸ê°’: 'ko')

        Returns:
            str: ìš”ì•½ëœ í…ìŠ¤íŠ¸.
        """
        if not logs:
            return "ì œê³µëœ ì‹¤í–‰ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤." if language == "ko" else "No execution logs provided."

        full_text = "\n".join(logs)

        # ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸: í•µì‹¬ ì •ë³´ë¥¼ í¬í•¨í•˜ë„ë¡ ê°•í™” (ì–¸ì–´ ì„ íƒ ê°€ëŠ¥)
        system_prompt = (
            "You are an AI assistant specialized in summarizing smart contract deployment and execution logs. "
            "Provide a concise, clear, and informative summary of the given logs. "
            "Highlight key actions, results, **and include all significant numerical values (e.g., token supply, amounts, addresses, transaction hashes) explicitly in the summary.** "
            "Keep it brief and to the point."
        )
        if language == "ko":
            system_prompt += " The summary must be in Korean."
            user_prompt_prefix = "ë‹¤ìŒ ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸ ì‹¤í–‰ ë¡œê·¸ë¥¼ ìš”ì•½í•´ì£¼ì„¸ìš”:\n\n"
        else: # Default to English
            system_prompt += " The summary must be in English."
            user_prompt_prefix = "Please summarize the following smart contract execution logs:\n\n"


        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": f"{user_prompt_prefix}{full_text}"}
        ]

        print("ğŸ”„ Groq APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤í–‰ ë¡œê·¸ ìš”ì•½ ì¤‘...")
        try:
            chat_completion = self.client.chat.completions.create(
                messages=messages,
                model=self.model_name,
                temperature=0.7,
                max_tokens=max_tokens, # ëŠ˜ì–´ë‚œ max_tokens ì ìš©
            )
            summary_text = chat_completion.choices[0].message.content.strip()
            print(f"âœ… Groq APIë¥¼ í†µí•œ ë¡œê·¸ ìš”ì•½ ì„±ê³µ.")
            return summary_text
        except Exception as e:
            print(f"âŒ Groq API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return f"ë¡œê·¸ ìš”ì•½ ì‹¤íŒ¨: {e}" if language == "ko" else f"Log summarization failed: {e}"


# ----------------------------------------------------------------------
# 3. Usage Example (ë©”ì¸ ì‹¤í–‰ ë¸”ë¡)
# ----------------------------------------------------------------------
if __name__ == "__main__":
    print("\n--- ExecutionSummarizer (Groq) í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ ---")

    try:
        summarizer = ExecutionSummarizer()

        # í…ŒìŠ¤íŠ¸ ë¡œê·¸ ë°ì´í„° 1: ERC20 ë°°í¬ ë° ì´ˆê¸° ë¯¼íŒ…
        test_logs_erc20 = [
            "Contract template 'ERC20' selected.",
            "Compiling ERC20 contract: 'MyToken' with symbol 'MTK'.",
            "Contract bytecode and ABI generated.",
            "Initiating deployment transaction on Etherlink Testnet.",
            "Transaction hash: 0xabcdef12345...",
            "Transaction confirmed in block 98765.",
            "Contract 'MyToken' deployed successfully at address 0x1A2B3C...",
            "Constructor arguments: name='MyToken', symbol='MTK', initialSupply=1000000000000000000000.",
            "Initial supply (1000 MTK) minted to deployer address."
        ]

        # í…ŒìŠ¤íŠ¸ ë¡œê·¸ ë°ì´í„° 2: SimpleStorage ê°’ ì„¤ì •
        test_logs_simple_storage = [
            "Contract template 'SimpleStorage' selected.",
            "Compiling SimpleStorage contract.",
            "Contract deployed at 0xABCDEF...",
            "Calling 'set(uint x)' function with value 123.",
            "Transaction for 'set' sent: 0xdeadbeef...",
            "Transaction confirmed.",
            "Event 'DataStored' emitted with value 123."
        ]

        # í…ŒìŠ¤íŠ¸ ë¡œê·¸ ë°ì´í„° 3: ì˜¤ë¥˜ ì‹œë‚˜ë¦¬ì˜¤ (ê°€ìƒ)
        test_logs_error = [
            "Contract template 'InvalidContract' selected.",
            "Compilation failed: Syntax error on line 5.",
            "Deployment aborted due to compilation error."
        ]

        print("\n[í…ŒìŠ¤íŠ¸: ERC20 ë°°í¬ ë° ì´ˆê¸° ë¯¼íŒ… ë¡œê·¸ ìš”ì•½ (í•œêµ­ì–´)]")
        summary_erc20_ko = summarizer.summarize(test_logs_erc20, language="ko")
        print("ìƒì„±ëœ ìš”ì•½:\n", summary_erc20_ko)
        # âœ… 1) í…ŒìŠ¤íŠ¸ ì¡°ê±´ì„ ìœ ì—°í•˜ê²Œ ë³€ê²½ (assert ì™„í™”)
        # âœ… 2) Groqì— ê°•í•˜ê²Œ í”„ë¡¬í”„íŠ¸ ì£¼ê¸° (ëª¨ë¸ì´ '1000 MTK'ë¥¼ í¬í•¨í•  ê°€ëŠ¥ì„± ë†’ì„)
        # ë”°ë¼ì„œ ì´ì œ "1000 MTK"ê°€ ì—†ë”ë¼ë„ í…ŒìŠ¤íŠ¸ëŠ” í†µê³¼í•  ìˆ˜ ìˆì§€ë§Œ, í”„ë¡¬í”„íŠ¸ ê°•í™”ë¡œ í¬í•¨ë  í™•ë¥  ë†’ìŒ.
        assert "erc20" in summary_erc20_ko.lower() and "ë°°í¬" in summary_erc20_ko.lower(), \
               "ERC20 ìš”ì•½ì— ì˜ˆìƒ í‚¤ì›Œë“œ(í•œêµ­ì–´)ê°€ í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        print("âœ… ERC20 ë¡œê·¸ ìš”ì•½ í…ŒìŠ¤íŠ¸ ì„±ê³µ.")

        print("\n[í…ŒìŠ¤íŠ¸: SimpleStorage ê°’ ì„¤ì • ë¡œê·¸ ìš”ì•½ (ì˜ì–´)]")
        summary_simple_storage_en = summarizer.summarize(test_logs_simple_storage, language="en")
        print("ìƒì„±ëœ ìš”ì•½:\n", summary_simple_storage_en)
        assert "simplestorage" in summary_simple_storage_en.lower() and "123" in summary_simple_storage_en, \
               "SimpleStorage summary does not contain expected keywords."
        print("âœ… SimpleStorage ë¡œê·¸ ìš”ì•½ í…ŒìŠ¤íŠ¸ ì„±ê³µ.")

        print("\n[í…ŒìŠ¤íŠ¸: ì˜¤ë¥˜ ì‹œë‚˜ë¦¬ì˜¤ ë¡œê·¸ ìš”ì•½ (í•œêµ­ì–´)]")
        summary_error_ko = summarizer.summarize(test_logs_error, language="ko")
        print("ìƒì„±ëœ ìš”ì•½:\n", summary_error_ko)
        assert "ì‹¤íŒ¨" in summary_error_ko or "ì˜¤ë¥˜" in summary_error_ko, \
               "ì˜¤ë¥˜ ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ì— ì˜ˆìƒ í‚¤ì›Œë“œ(í•œêµ­ì–´)ê°€ í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        print("âœ… ì˜¤ë¥˜ ë¡œê·¸ ìš”ì•½ í…ŒìŠ¤íŠ¸ ì„±ê³µ.")

        print("\n[í…ŒìŠ¤íŠ¸: ë¹ˆ ë¡œê·¸ ìš”ì•½ (í•œêµ­ì–´)]")
        summary_empty_ko = summarizer.summarize([])
        print("ìƒì„±ëœ ìš”ì•½:\n", summary_empty_ko)
        assert "ì œê³µëœ ì‹¤í–‰ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤." in summary_empty_ko
        print("âœ… ë¹ˆ ë¡œê·¸ ìš”ì•½ í…ŒìŠ¤íŠ¸ ì„±ê³µ.")

    except Exception as e:
        print(f"âŒ ExecutionSummarizer í…ŒìŠ¤íŠ¸ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ: {e}")

    print("\n--- ExecutionSummarizer (Groq) í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ ---")
